# 访问者模式

## 概述

在医生开具处方单（药单）后，很多医院都存在以下处理流程：划价人员拿到处方单以后根据药品名称和数量计算总价，药房工作人员根据药品名称和数量准备药品。

可以将处方单看成一个药品信息的集合，里面包含了一种或多种不同类型的药品信息，不同类型的工作人员在操作同一个药品信息集合时将提供不同的处理方式，而且可能还会增加新类型的工作人员来操作处方单。

在软件开发中有时候也需要处理像处方单这样的集合对象结构，在该对象结构中存储了多种不同类型的对象信息，而且同一对象结构中的元素的操作方式并不唯一，可能需要提供多种不同的处理方式i，还有可能增加新的处理方式。在设计模式中有一种模式可以满足上述要求，其模式动机就是以不同的方式操作复杂对象结构，该模式就是访问模式。

访问模式是一种较为复杂的行为型设计模式，它包含访问者和被访问元素两个主要组成部分，这些被访问的元素通常具有不同的类型，且不同的访问者可以对它们进行不同的访问操作。例如处方单中的各种药品信息就是被访问的元素，而划价人员和药房工作人员就是访问者。访问者模式使得用户可以在不修改现有系统的情况下扩展系统的功能，为这些不同类型的元素增加新的操作。

在使用访问者模式时，被访问元素通常不是单独存在的，它们存储在一个集合中，这个集合被称为“对象结构”，访问者通过遍历对象结构实现对其中存储的元素的逐个操作。

**访问者模式**：表示一个作用于某对象结构中的各个元素的操作。访问者模式让用户可以在不改变各元素的类的前提下定义作用于这些元素的新操作。

> **Visitor Pattern**: Represent an operation to be performed on the elements of an object structure. visitor lets you define a new operation without changing the classes of the elements on which it operates.

访问者模式是一种对象行为型模式，它为操作存储不同类型元素的对象结构提供了一种解决方案，用户可以对不同类型的元素施加不同的操作。

## 结构与实现

### 结构

访问者模式的结构如下图。

![visitor-pattern.svg](./assets/visitor-pattern.svg)

访问者模式包含 5 个角色：

1. **Visitor（抽象访问者）**：抽象访问者为对象结构中的每一个具体元素类声明了一个访问操作，从这个操作的名称或参数类型可以清楚地知道需要访问的具体元素的类型，具体访问者需要实现这些操作方法，定义对这些元素的访问操作。
2. **ConcreteVisitor（具体访问者）**：具体访问者实现了每个由抽象访问者声明的操作，每一个操作用于访问对象结构中一种类型的元素。
3. **Element（抽象元素）**：抽象元素一般是抽象类或接口，它声明了一个 accept() 方法，用于接受访问者的访问操作，该方法通常以一个抽象访问者作为参数。
4. **ConcreteElement（具体元素）**：具体元素实现了 accept() 方法，在 accept() 方法中调用访问者的访问方法以便完成对一个元素的操作。
5. **ObjectStructure（对象结构）**：对象结构是一个元素的结合，它用于存放元素对象，并且提供了遍历其内部元素的方法。对象结构可以结合组合模式来实现，也可以是一个简单的集合对象。

### 实现

[访问者模式实现示例](./examples/designpattern/visitor)

## 访问者模式与组合模式联用

在访问者模式中包含一个用于存储元素对象的对象结构，通常可以使用迭代器来遍历对象结构，同时具体元素之间可以存在整体与部分关系，有些元素作为容器对象，有些元素作为成员对象，可以使用组合模式来组织元素。引入组合模式后的访问者结构图如下。

![composite-visitor-pattern.svg](./assets/composite-visitor-pattern.svg)

## 优/缺点与适用环境

### 优点

1. 在访问者模式中增加新的访问操作很方便。使用访问者模式，增加新的访问操作就意味着增加一个新的具体访问者类，实现简单，无须修改源代码，符合开闭原则。
2. 访问者模式将有关元素对象的访问行为集中到一个访问者对象中，而不是分散在一个个的元素类中。类的职责更加清晰，有利于对象结构中元素对象的复用，相同的对象结构可以供多个不同的访问者访问。
3. 访问者模式让用户能够在不修改现有元素类层次结构的情况下定义作用于该层次结构的操作。

### 缺点

1. 在访问者模式中增加新的元素类很困难。在访问者模式中，每增加一个新的元素类都意味着要在抽象访问者角色中增加一个新的抽象操作，并在每一个具体访问者类中增加相应的具体操作，这违背了开闭原则的要求。
2. 访问者模式破坏了对象的封装性。访问者模式要求访问者对象访问并调用每一个元素对象的操作，这意味着元素对象有时必须暴露一些自己的内部操作和内部状态，否则无法供访问者访问。

### 适用环境

1. 一个对象结构包含多个类型的对象，希望对这些对象实施一些依赖其具体类型的操作。在访问者中针对每一种具体的类型都提供了一个访问操作，不同类型的对象可以有不同的访问操作。
2. 需要对一个对象结构中的对象进行很多不同的并且不相关的操作，而需要避免让这些操作“污染”这些对象的类，也不希望在增加新操作时修改这些类。访问者模式使得用户可以将相关的访问操作集中起来定义在访问者类中，对象结构可以被多个不同的访问者类所泗洪，将对象本身与对象的访问操作分离。
3. 对象结构中对象对应的类型很少改变，但经常需要在此对象结构上定义新的操作。
